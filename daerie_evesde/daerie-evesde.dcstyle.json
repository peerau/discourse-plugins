{"theme":{"id":7,"name":"Daerie EVESDE","created_at":"2018-09-08T11:13:16.748Z","updated_at":"2018-09-08T11:13:16.748Z","component":true,"color_scheme":null,"color_scheme_id":null,"user_selectable":false,"remote_theme_id":null,"user":{"id":1,"username":"warlof","name":"","avatar_template":"/user_avatar/forums.clandaerie.com/warlof/{size}/44_1.png","title":"Membre EVE Online"},"theme_fields":[{"name":"head_tag","target":"common","value":"\u003cscript src=\"https://unpkg.com/dexie@latest/dist/dexie.js\"\u003e\u003c/script\u003e\n\u003cscript type=\"text/javascript\"\u003e\n    const EVE_ONLINE_SDE_CDN = 'https://sde.zzeve.com';\n        \n    // instanciate a new database\n    var db = new Dexie('eveonline_sde');\n    \n    // define the Eve Online SDE structure\n    db.version(1).stores({\n        meta: 'table',                   // this will allow us to refresh data when needed\n        invTypes: 'typeID, typeName',    // typeID is primary key, typeName will be used for search based on link\n        dgmAttributeTypes: 'attributeID' // attributeID is primary key\n    });\n    \n    seedEveOnlineSDEDatabase('invTypes');\n    seedEveOnlineSDEDatabase('dgmAttributeTypes');\n    \n    function seedEveOnlineSDEDatabase(tableName)\n    {\n        // attempt to retrieve meta information regarding tableName\n        db.meta.get(tableName, function(meta) {\n            // in case there is no result, insert a new entry into the database\n            if (meta === null || meta === undefined) {\n                meta = {\n                    table: tableName,\n                    etag: \"\",\n                    lastModified: new Date('1970-01-01T00:00:01')\n                };\n                \n                return db.meta.add(meta);\n            }\n            \n            $.ajax({\n                dataType: 'json',\n                headers: {\n                    //'If-None-Match': meta.etag\n                    //'If-Modified-Since': meta.lastModified.toGMTString()\n                },\n                method: 'GET',\n                url: EVE_ONLINE_SDE_CDN + '/' + tableName + '.json'\n            }).done(function(data, textStatus, jqXHR) {\n                if (meta.etag !== jqXHR.getResponseHeader('ETag')) {\n                    console.warn('refreshing data for ' + tableName);\n                    \n                    // emptying tableName in order to reload updated information\n                    db[tableName].clear();\n                    \n                    // seeding tableName with updated information\n                    if (data.length \u003e 0) db[tableName].bulkAdd(data);\n                    \n                    // update metadata related to tableName\n                    db.meta.update(tableName, {\n                        etag: jqXHR.getResponseHeader('ETag'),\n                        lastModified: jqXHR.getResponseHeader('Last-Modified')\n                    }).catch(function (err) {\n                        console.error(err);\n                    });\n                }\n            });\n        });\n    }\n\u003c/script\u003e\n\u003cscript type=\"text/x-handlebars\" data-template-name=\"modal/eve-sde-modal\"\u003e\n    {{#d-modal-body title=\"eve_sde_modal_title\" class=\"eve-sde-modal\"}}\n    \u003cp data-typeid=\"{{ model.type_id }}\"\u003e{{{ model.description }}}\u003c/p\u003e\n    {{#if (or model.attributes.shield model.attributes.armor model.attributes.hull)}}\n    \u003ctable\u003e\n        \u003cthead\u003e\n            \u003ctr\u003e\n                \u003cth colspan=\"4\"\u003e\n                    \u003ch3\u003eResistances\u003c/h3\u003e\n                \u003c/th\u003e\n            \u003c/tr\u003e\n        \u003c/thead\u003e\n        \u003ctbody\u003e\n            {{#if model.attributes.shield }}\n            \u003ctr\u003e\n                \u003ctd colspan=\"4\"\u003e\n                    \u003ch4\u003eShield\u003c/h4\u003e\n                \u003c/td\u003e\n            \u003c/tr\u003e\n            \u003ctr\u003e\n                {{#each model.attributes.shield as |attribute|}}\n                \u003ctd\u003e\n                    \u003cimg src=\"{{ attribute.img.src }}\" alt=\"{{ attribute.img.alt }}\" /\u003e {{ attribute.percent }}\n                \u003c/td\u003e\n                {{/each}}\n            \u003c/tr\u003e\n            {{/if}}\n            {{#if model.attributes.armor }}\n            \u003ctr\u003e\n                \u003ctd colspan=\"4\"\u003e\n                    \u003ch4\u003eArmor\u003c/h4\u003e\n                \u003c/td\u003e\n            \u003c/tr\u003e\n            \u003ctr\u003e\n                {{#each model.attributes.armor as |attribute|}}\n                \u003ctd\u003e\n                    \u003cimg src=\"{{ attribute.img.src }}\" alt=\"{{ attribute.img.alt }}\" /\u003e {{ attribute.percent }}\n                \u003c/td\u003e\n                {{/each}}\n            \u003c/tr\u003e\n            {{/if}}\n            {{#if model.attributes.hull }}\n            \u003ctr\u003e\n                \u003ctd colspan=\"4\"\u003e\n                    \u003ch4\u003eHull\u003c/h4\u003e\n                \u003c/td\u003e\n            \u003c/tr\u003e\n            \u003ctr\u003e\n                {{#each model.attributes.hull as |attribute|}}\n                \u003ctd\u003e\n                    \u003cimg src=\"{{ attribute.img.src }}\" alt=\"{{ attribute.img.alt }}\" /\u003e {{ attribute.percent }}\n                \u003c/td\u003e\n                {{/each}}\n            \u003c/tr\u003e\n            {{/if}}\n        \u003c/tbody\u003e\n    \u003c/table\u003e\n    {{/if}}\n    {{/d-modal-body}}\n\u003c/script\u003e\n\u003cscript type=\"text/discourse-plugin\" version=\"0.8.24\"\u003e\n    const ESI_BASE_URI = 'https://esi.evetech.net';\n    const RESISTS = [109, 110, 111, 113, 267, 268, 269, 270, 271, 272, 273, 274];\n    const showModal = require('discourse/lib/show-modal').default;\n    let currentLocale = I18n.currentLocale();\n\n    function showEveOnlineSDEModal()\n    {\n        var typeID  = $(this).attr('data-typeid');\n        var typeUri = ESI_BASE_URI + '/latest/universe/types/' + typeID + '/';\n        \n        if (typeID === null || typeID === undefined) {\n            console.warn('The item does not have any typeID attribute.');\n            return;\n        }\n    \n        $.ajax({\n            data : {\n                language: 'fr'\n            },\n            dataType: 'json',\n            headers: {\n                'Accept-Language': 'fr',\n                'X-User-Agent': 'discourse/1.0.0 (Warlof Tutsimo - Daerie Inc. - Get Off My Lawn)'\n            },\n            type: 'GET',\n            url: typeUri\n        }).done(function(data) {\n            var sdeModel = {\n                'type_id': 0,\n                'description': '',\n                'attributes': {\n                    'shield': [],\n                    'armor': [],\n                    'hull': []\n                }\n            };\n            \n            var resistsAttributesID = [];\n            var resistsAttributes = [];\n            \n            I18n.translations[currentLocale].js.eve_sde_modal_title = data.name;\n            sdeModel.type_id = typeID;\n            sdeModel.description = data.description\n                .replace(/\\r\\n/gi, '\u003cbr/\u003e')\n                .replace(/\\n\\n/gi, '\u003cbr/\u003e')\n                .replace(/\\n/gi, '\u003cbr/\u003e')\n                .replace(/\u003ccolor='0xff([a-f0-9]{6})'\u003e([a-z0-9,.']+)\u003c\\/color\u003e/gmi, function(match, p1, p2, offset, string) {\n                    return `\u003cspan style=\"color: #${p1};\"\u003e${p2}\u003c/span\u003e`;\n                })\n                .replace(/\u003ca href=showinfo:([0-9]+)\u003e([éèàçù \\w]+)\u003c\\/a\u003e/gmi, function(match, p1, p2, offset, string) {\n                    return p2;\n                });\n            \n            $.each(data.dogma_attributes, function(i, dgmAttribute) {\n                if (RESISTS.indexOf(dgmAttribute.attribute_id) \u003e= 0) {\n                    resistsAttributes.push(dgmAttribute);\n                    resistsAttributesID.push(dgmAttribute.attribute_id);\n                }\n            });\n            \n            db.dgmAttributeTypes.where('attributeID').anyOf(resistsAttributesID).toArray().then(function (dgmAttributeTypes) {\n                if (dgmAttributeTypes === null || dgmAttributeTypes === undefined)\n                    return;\n\n                $.each(dgmAttributeTypes, function(i, dgmAttributeType) {\n                    $.each(resistsAttributes, function(j, resistAttribute) {\n                        if (resistAttribute.attribute_id === dgmAttributeType.attributeID) {\n                            var attribute = {\n                                'id': 0,\n                                'name': '',\n                                'value': '',\n                                'percent': 0,\n                                'img': {\n                                    'alt': '',\n                                    'src': ''\n                                }\n                            };\n                            \n                            switch (dgmAttributeType.iconID) {\n                                case 1393:\n                                    attribute.img.src = 'https://forums.clandaerie.com/uploads/default/original/1X/a948a8f3d0ac5a1628c110071aceef976db0fae5.png';\n                                    break;\n                                case 1394:\n                                    attribute.img.src = 'https://forums.clandaerie.com/uploads/default/original/1X/4d8ef4c39d6baa27845ff8931c63fc4c08cc7bbb.png';\n                                    break;\n                                case 1395:\n                                    attribute.img.src = 'https://forums.clandaerie.com/uploads/default/original/1X/281dbfadd89530cc1142a4b93fdc7ada671297eb.png';\n                                    break;\n                                case 1396:\n                                    attribute.img.src = 'https://forums.clandaerie.com/uploads/default/original/1X/b3f1e97f6144ec32c601294bfe2a2abc7cd9adfd.png';\n                                    break;\n                            }\n                            \n                            attribute.id = dgmAttributeType.attributeID;\n                            attribute.name = dgmAttributeType.displayName;\n                            attribute.value = resistAttribute.value;\n                            attribute.percent = Math.round((1 - attribute.value) * 100);\n                            attribute.img.alt = attribute.name.replace(/Armor|Shield|Structure/gi, '').trim();\n                            \n                            switch (dgmAttributeType.categoryID) {\n                                // Shield\n                                case 2:\n                                    sdeModel.attributes.shield.push(attribute);\n                                    break;\n                                // Armor\n                                case 3:\n                                    sdeModel.attributes.armor.push(attribute);\n                                    break;\n                                // Structure\n                                case 4:\n                                    sdeModel.attributes.hull.push(attribute);\n                                    break;\n                            }\n                        }\n                    });\n                });\n            })\n            .then(function () {\n                showModal('eveSdeModal', {\n                    'model': sdeModel\n                });\n            })\n            .catch(function(err) {\n                console.error(err);\n            });\n        });\n    }\n    \n    //\n    // EvE Online Magic SDE\n    //\n    \n    // append an icon near the modal title if it's an EvE Online SDE modal\n    api.onAppEvent('modal:body-shown', msg =\u003e {\n        if (msg.title !== 'eve_sde_modal_title')\n            return;\n            \n        var typeID = $('.modal-body p').attr('data-typeid');\n        $('.modal-header .title h3 img').remove();\n        $('.modal-header .title h3').prepend(\n            $('\u003cimg\u003e').attr('src', `//image.eveonline.com/Type/${typeID}_32.png`)\n                      .attr('alt', 'Icon')\n                      .css('margin-right', '10px'));\n    });\n    \n    api.decorateCooked(function(cooked) {\n        // retrieving all link targetting EvE Online SDE\n        cooked.find('a[href=\"#evesde\"]').each(function(index, sdeLink) {\n            // attempt to identifying the item and add its ID as data attribute\n            db.invTypes.where({'typeName': $(sdeLink).text()}).first(function (invType) {\n                if (invType === null || invType === undefined) {\n                    console.warn('The is no match for this link');\n                    return;\n                }\n                \n                $('a[href=\"#evesde\"]:contains(' + invType.typeName + ')').attr('data-typeid', invType.typeID);\n                $('a[href=\"#evesde\"]:contains(' + invType.typeName + ')').on('click', showEveOnlineSDEModal);\n            }).catch(function (err) {\n                console.error(err);\n            });\n        });\n    }, {onlyStream: true});\n\u003c/script\u003e","type_id":0},{"name":"scss","target":"common","value":".eve-sde-modal p {\n    text-align: justify;\n}\n","type_id":1}],"remote_theme":null}}
